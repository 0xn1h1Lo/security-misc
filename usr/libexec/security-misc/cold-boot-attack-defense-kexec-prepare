#!/bin/bash
## Copyright (C) 2023 - 2023 ENCRYPTED SUPPORT LP <adrelanos@whonix.org>
## Copyright (C) 2023 - 2023 Friedrich Doku <friedrichdoku@gmail.com>
## See the file COPYING for copying conditions.
set -x
set -e

true "env:"
env

## Debugging.
## Lets hope $1 is set to reboot, poweroff or halt by systemd.
true "1: $1"

initrd=/boot/initrd.img-$(uname -r)
kernel=/boot/vmlinuz-$(uname -r)

if test -e $initrd; then
  echo "Initrd File Found"
else
  echo "Initrd File NOT FOUND"
  exit 1
fi

if test -e $kernel; then
  echo "Kernel File Found"
else
  echo "Kernel File NOT FOUND"
  exit 1
fi


dbus-monitor --system  |
    while read -r line; do
         if [[ $line =~ .*"poweroff.target".* ]]; then
	    kexec -l $kernel --initrd=$initrd --reuse-cmdline --append="wiperamexit=yes wiperamaction=poweroff"
	    break
	 fi

         if [[ $line =~ .*"reboot.target".* ]]; then
	    kexec -l $kernel --initrd=$initrd --reuse-cmdline --append="wiperamexit=yes wiperamaction=reboot"
	    break
	 fi
	 
	 if [[ $line =~ .*"halt.target".* ]]; then
	    kexec -l $kernel --initrd=$initrd --reuse-cmdline --append="wiperamexit=yes wiperamaction=halt"
	    break
	 fi
         
	 if [[ $line =~ .*"kexec.target".* ]]; then
	    kexec -l $kernel --initrd=$initrd --reuse-cmdline --append="wiperamexit=yes wiperamaction=reboot"
	    break
	 fi
    done

